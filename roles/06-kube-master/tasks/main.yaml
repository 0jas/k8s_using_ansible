---
- name: Check if cluster is already initialized (on master1)
  ansible.builtin.stat:
    path: /etc/kubernetes/admin.conf
  register: kubeadmin_conf
  when: inventory_hostname == groups['masters'][0]
  tags: ['kube-master', 'kubeadm-check']

- name: Prepare kubeadm init configuration
  ansible.builtin.template:
    src: kubeadm-config.yaml.j2
    dest: /tmp/kubeadm-config.yaml
    mode: '0640'
  when:
    - inventory_hostname == groups['masters'][0]
    - not kubeadmin_conf.stat.exists
  tags: ['kube-master', 'kubeadm-config']

- name: Initialize first master (master1)
  ansible.builtin.command: >
    kubeadm init --config /tmp/kubeadm-config.yaml --upload-certs
  register: kubeadm_init
  changed_when: kubeadm_init.rc == 0
  when:
    - inventory_hostname == groups['masters'][0]
    - not kubeadmin_conf.stat.exists
  tags: ['kube-master', 'kubeadm-init']

- name: Define kube config directory path
  ansible.builtin.set_fact:
    kube_config_dir_path: "{{ (ansible_user == 'root') | ternary('/root/.kube', '/home/' + ansible_user + '/.kube') }}"
  when:
    - inventory_hostname == groups['masters'][0]
    - kubeadm_init.changed
  tags: ['kube-master', 'kubeadm-config-dir']

- name: Create .kube directory for user
  ansible.builtin.file:
    path: "{{ kube_config_dir_path }}"
    state: directory
    mode: '0755'
  when:
    - inventory_hostname == groups['masters'][0]
    - kubeadm_init.changed
  tags: ['kube-master', 'kubeadm-kubeconfig-dir']

- name: Copy admin.conf to user's .kube directory
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: "{{ kube_config_dir_path }}/config"
    remote_src: yes
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
  when:
    - inventory_hostname == groups['masters'][0]
    - kubeadm_init.changed
  tags: ['kube-master', 'kubeadm-kubeconfig-copy']

# --- Token Generation and Fact Setting ---
- name: Get worker join token
  ansible.builtin.command: kubeadm token create --print-join-command
  register: worker_join_command
  changed_when: false
  when: inventory_hostname == groups['masters'][0]
  tags: ['kube-master', 'kubeadm-worker-join']

- name: Get master join certificate key
  ansible.builtin.command: kubeadm init phase upload-certs --upload-certs
  register: master_cert_key
  changed_when: false
  when: inventory_hostname == groups['masters'][0]
  tags: ['kube-master', 'kubeadm-master-cert-key']

- name: Store join commands as facts for other hosts
  ansible.builtin.set_fact:
    worker_join_cmd: "{{ worker_join_command.stdout }}"
    master_cert_key_val: "{{ master_cert_key.stdout_lines | last }}"
  when: inventory_hostname == groups['masters'][0]
  tags: ['kube-master', 'kubeadm-set-join-facts']

# --- Join other masters ---
- name: Check if this master is already joined
  ansible.builtin.stat:
    path: /etc/kubernetes/admin.conf
  register: master_joined_check
  tags: ['kube-master', 'kubeadm-master-joined-check']

- name: Join other master nodes
  ansible.builtin.command: >
    {{ hostvars[groups['masters'][0]]['worker_join_cmd'] }}
    --control-plane
    --certificate-key {{ hostvars[groups['masters'][0]]['master_cert_key_val'] }}
  register: join_master
  changed_when: "'This node has joined the cluster' in join_master.stdout"
  when:
    - inventory_hostname != groups['masters'][0]
    - not master_joined_check.stat.exists
  tags: ['kube-master', 'kubeadm-join-master']